(function(){"use strict";TS.registerModule("highlights_briefing",{sli_recaps_debug_group:null,sli_briefings_preview_group:null,sli_briefings_dark_test_group:null,updated_sig:new signals.Signal,$briefing_header:null,$briefing_view:null,onStart:function(){if(!TS.client)return;TS.client.ui.unread.started_sig.add(_onEnterView);TS.client.unread.switched_away_sig.add(_resetState);TS.client.unread.marked_group_as_read_sig.add(_removeMessagesWithChannel);TS.client.unread.marked_group_as_unread_sig.add(_unremoveMessagesWithChannel);TS.channels.switched_sig.add(_handleChannelSwitch);TS.groups.switched_sig.add(_handleChannelSwitch);TS.experiment.loadUserAssignments().then(function(){TS.highlights_briefing.sli_recaps_debug_group=TS.experiment.getGroup("sli_recaps_debug");TS.highlights_briefing.sli_briefings_preview_group=TS.experiment.getGroup("sli_briefings_preview");TS.highlights_briefing.sli_briefings_dark_test_group=TS.experiment.getGroup("sli_briefings_dark_test");var is_in_either_group=TS.highlights_briefing.sli_briefings_preview_group==="sli_briefings_preview"||TS.highlights_briefing.sli_briefings_dark_test_group==="sli_briefings_dark_test";if(is_in_either_group&&_tried_to_load){_onEnterView()}})},getDebugInfoFor:function(ts,channel_id){return _.get(_cached_messages[channel_id][ts],"score")},getMessageFromCache:function(channel_id,ts){return _.get(_cached_messages,[channel_id,ts],null)},isEnabled:function(){return TS.highlights_briefing.sli_briefings_preview_group==="sli_briefings_preview"},showBriefing:function(){_$briefing_container.removeClass("hidden");_$briefing_header.toggleClass("hidden",!_interface_state.expanded)},hideBriefing:function(){_$briefing_container.addClass("hidden");_$briefing_header.addClass("hidden")},sendFeedback:function(e,action,ts,model_ob_id){var existing_feedback=_getFeedback(ts,model_ob_id);if(existing_feedback!=="dismiss"){var $briefing=$('.sli_briefing__message[data-cache-id="'+model_ob_id+"-"+ts+'"]');var message=_.get(_cached_messages,[model_ob_id,ts]);if(action==="dismiss"){_feedbackAndDismiss($briefing,action,ts,model_ob_id);var feedback_args=_.assign({},message.feedback_options.dismiss.args,{request_id:message.request_id});if(message.cached_request_id){feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",feedback_args)}else if(action==="negative"){$briefing.find("ts-message").addClass("hidden");$briefing.addClass("gave_negative_feedback");$(e.target).addClass("sli_briefing__feedback_control--pulse");$('[data-feedback-for-cache-id="'+model_ob_id+"-"+ts+'"]').removeClass("hidden");_setFeedback("negative",ts,model_ob_id);var default_negative_feedback_args=_.assign({},message.feedback_options.default_negative.args,{request_id:message.request_id});if(message.cached_request_id){default_negative_feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",default_negative_feedback_args)}else if(action==="positive"){$briefing.addClass("gave_positive_feedback");$(e.target).addClass("sli_briefing__feedback_control--pulse");_setFeedback("positive",ts,model_ob_id);var default_positive_feedback_args=_.assign({},message.feedback_options.default_positive.args,{request_id:message.request_id});if(message.cached_request_id){default_positive_feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",default_positive_feedback_args)}}},jumpToMessageInChannel:function(channel_id,ts){_jumpToMessageInChannel(channel_id,ts)}});var _$briefing_container=null;var _$briefing_view=null;var _$briefing_preview_container=null;var _$briefing_header=null;var _cached_messages={};var _cached_feedback={};var _interface_state={expanded:false,scroll_top:0,last_jump:{ts:null,model_ob_id:null},show_briefing_back_button:false,last_open_ts:null};var _tried_to_load=false;var _last_request_id=null;var _cached_headline={};var _onEnterView=function(){if(TS.highlights_briefing.sli_briefings_preview_group===null&&TS.highlights_briefing.sli_briefings_dark_test_group===null){_tried_to_load=true;return}if(TS.highlights_briefing.sli_briefings_preview_group!=="sli_briefings_preview"){if(TS.highlights_briefing.sli_briefings_dark_test_group==="sli_briefings_dark_test"){TS.api.call("highlights.briefing")}return}if(_interface_state.show_briefing_back_button||_.get(_interface_state,["last_jump","model_ob_id"])){_hideBackButtonInChannel()}_interface_state.briefing_opens_count=TS.storage.fetchBriefingOpensCount();_createBriefingContainer();TS.api.call("highlights.briefing").then(_processMessages).then(_renderBriefing).catch(function(err){TS.error("A call to highlights.briefing failed:");TS.error(err)});_bindUi()};var _processMessages=function(d){if(_.get(d,"data.messages.length")){d.data.messages=_.map(d.data.messages,function(message){var channel_id=message.channel_id;var normalized_msg=TS.utility.msgs.processImsg(message,channel_id);normalized_msg.channel=message.channel;normalized_msg.justification=TS.format.formatWithOptions(message.justification||"",message,{no_linking:true});normalized_msg.score=message.score;normalized_msg.feedback_options=message.feedback_options;normalized_msg.request_id=message.request_id;normalized_msg.cached_request_id=message.cached_request_id;normalized_msg.is_briefing_message=true;return normalized_msg})}return d};var _createBriefingContainer=function(){$("#unread_msgs_div").before(TS.templates.sli_briefing({show_onboarding:_interface_state.briefing_opens_count<3}));$("#unread_msgs_scroller_div").prepend(TS.templates.sli_briefing_header())};var _renderBriefing=function(d){_last_request_id=d.request_id;if(_interface_state.last_open_ts!==null&&_interface_state.last_open_ts<Date.now()-15*1e3*60){_interface_state.expanded=false}if(_.get(d,"data.messages.length")){var grouped_by_channel=_.groupBy(d.data.messages,"channel.id");var rendered_message_groups=_(grouped_by_channel).map(function(group,key){var channel_group={channel:TS.shared.getModelObById(key),messages:_(group).map(function(message){var feedback=_getFeedback(message.ts,message.channel.id);var feedback_class=_getFeedbackClass(feedback);if(feedback&&feedback!=="jump"&&feedback!=="positive")return null;var negative_feedback_options=_.map(message.feedback_options.negative,function(item){return _.assign({},item,{text:new Handlebars.SafeString(TS.format.formatWithOptions(item.text,null,{no_linking:true}))})});return{message_markup:_renderBriefingMessage(message),message:message,justification:message.justification?new Handlebars.SafeString(message.justification):null,feedback_class:feedback_class,negative_feedback_options:negative_feedback_options}}).compact().value()};if(!channel_group.messages.length){return null}return channel_group}).compact().value();if(rendered_message_groups.length){_cacheMessages(d.data.messages);_$briefing_view.find(".sli_briefing_view__messages").html(TS.templates.sli_briefing_message_view({groups:rendered_message_groups}));_renderBriefingDebugLink()}}else{_cached_messages={}}_cached_headline={header:TS.format.formatWithOptions(d.data.headline.header||"","",{no_linking:true}),subheader:TS.format.formatWithOptions(d.data.headline.subheader||"","",{no_linking:true})};var active_briefing_count=_getActiveBriefingCount();if(_interface_state.expanded&&active_briefing_count){_$briefing_preview_container.addClass("hidden");_$briefing_view.removeClass("hidden");_$briefing_header.removeClass("hidden")}else if(_interface_state.expanded&&!active_briefing_count){_interface_state.expanded=false;_$briefing_preview_container.removeClass("hidden");_$briefing_view.addClass("hidden");_$briefing_header.addClass("hidden");_renderCollapsedView(null,0,true)}else{var headline=_getCurrentHeadline();_renderCollapsedView(headline,_getActiveBriefingCount())}var last_jump_channel=_.get(_interface_state,["last_jump","model_ob_id"]);var last_jump_ts=_.get(_interface_state,["last_jump","ts"]);if(_.get(_cached_messages,[last_jump_channel,last_jump_ts])){_interface_state.scroll_top=0;_interface_state.last_jump.ts=null;_interface_state.last_jump.model_ob_id=null}TS.highlights_briefing.updated_sig.dispatch()};var _renderBriefingMessage=function(message){var $msg=$(TS.templates.builders.msgs.buildHTML({msg:message,model_ob:message.channel,enable_slack_action_links:true,container_id:"sli_briefing",prev_msg:null,briefing:true}));if(message.pinned_to&&message.pinned_to.length||_.get(message,"file.pinned_to.length"))$msg.removeClass("is_pinned");$msg.addClass("is_sli_briefing");return $msg[0].outerHTML};var _renderCollapsedView=function(headline,count,cleared){if(headline&&count){_$briefing_preview_container.removeClass("sli_briefing_preview--loading").addClass("sli_briefing_preview--has_briefings");_$briefing_preview_container.find('[data-js="sli_briefing_preview_title"]').html(headline.header);_$briefing_preview_container.find('[data-js="sli_briefing_preview_description"]').html(headline.subheader);_$briefing_preview_container.find('[data-js="sli_briefing_preview_action"]').removeClass("hidden")}else if(cleared){_$briefing_preview_container.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");_$briefing_preview_container.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("That’s it!","highlights")());_$briefing_preview_container.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("Check back later for more.","highlights")());_$briefing_preview_container.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}else{_$briefing_preview_container.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");_$briefing_preview_container.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("No new highlights","highlights")());_$briefing_preview_container.find('[data-js="sli_briefing_preview_description"]').text(_getRandomTip());_$briefing_preview_container.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}TS.highlights_briefing.updated_sig.dispatch()};var _renderBriefingDebugLink=function(){var feedback_domain="https://staging.slack.com";if(TS.boot_data.version_ts==="dev"){feedback_domain="https://dev.slack.com"}var briefing_feedback_url=feedback_domain+"/god/sli_highlights_briefing.php?request_id="+_last_request_id;$('[data-js="sli_briefing_feedback_url"]').attr("href",briefing_feedback_url)};var _getRandomTip=function(){var strings=[TS.i18n.t("To help Slack find your highlights, star a few of your favorite channels.","highlights")(),TS.i18n.t("Pin, star, and share messages to help fine-tune your highlights.","highlights")(),TS.i18n.t("Leave a reaction (or two!) to teach Slack what catches your eye.","highlights")(),TS.i18n.t("Slack’s a fast learner: when you leave feedback on a highlight, we’ll adjust.","highlights")(),TS.i18n.t("But we’ll keep an ear to the ground.","highlights")()];return strings[_.random(strings.length-1)]};var _cacheMessages=function(messages){_cached_messages={};_.forEach(messages,function(message){_cached_messages[message.channel.id]=_cached_messages[message.channel.id]||{};_cached_messages[message.channel.id][message.ts]=message})};var _resetState=function(){if(TS.highlights_briefing.sli_briefings_preview_group!=="sli_briefings_preview")return;_unbindUi();_$briefing_container=null;_$briefing_view=null;_$briefing_preview_container=null;_$briefing_header=null;TS.highlights_briefing.$briefing_header=null;TS.highlights_briefing.$briefing_view=null;_last_request_id=null;_cached_headline=null;_interface_state.last_open_ts=Date.now();_.each(_cached_feedback,function(channel){_.each(channel,function(feedback,ts){if(feedback==="negative"){channel[ts]="dismiss"}})})};var _getActiveBriefingCount=function(){return _.reduce(_cached_messages,function(channel_sum,channel_messages){return channel_sum+_.reduce(channel_messages,function(messages_sum,message){if(message._removed||_getFeedback(message.ts,message.channel.id)==="dismiss"){return messages_sum}return messages_sum+1},0)},0)};var _getActiveBriefings=function(){return _(_cached_messages).flatMap(function(messages){return _.map(messages,function(message){if(message._removed||_getFeedback(message.ts,message.channel.id)==="dismiss"){return null}return message})}).compact().value()};var _getCurrentHeadline=function(){return _cached_headline};var _setFeedback=function(action,ts,model_ob_id){if(!_cached_feedback[model_ob_id])_cached_feedback[model_ob_id]={};_cached_feedback[model_ob_id][ts]=action};var _getFeedback=function(ts,model_ob_id){return _.get(_cached_feedback,[model_ob_id,ts])};var _getFeedbackClass=function(action){if(action==="negative")return"gave_negative_feedback";if(action==="positive")return"gave_positive_feedback";if(action==="dismiss")return"sli_briefing__feedback--dismiss";return""};var _handleChannelSwitch=function(){if(!TS.highlights_briefing.isEnabled())return;if(TS.model.active_cid===_.get(_interface_state,["last_jump","model_ob_id"])&&_interface_state.show_briefing_back_button){_showBackButtonInChannel()}else if(_interface_state.last_jump&&_interface_state.show_briefing_back_button){_hideBackButtonInChannel()}};var _showBackButtonInChannel=function(){$(".sli_briefing__channel_back_button").removeClass("hidden");$("#messages_unread_status").addClass("sli_briefing--has_back_button")};var _hideBackButtonInChannel=function(){$(".sli_briefing__channel_back_button").addClass("hidden");$("#messages_unread_status").removeClass("sli_briefing--has_back_button");_interface_state.show_briefing_back_button=false};var _clogFeedback=function(action,msg_ts,channel_id){if(action==="dismiss"){var clog_args={request_id:_last_request_id,message_timestamp:msg_ts,channel_id:channel_id,channel_type:channel_id[0]||""};var cached_request_id=_.get(_cached_messages,[channel_id,msg_ts,"cached_request_id"]);if(cached_request_id){clog_args.cached_request_id=cached_request_id}TS.clog.track("MSG_BRIEFING_DISMISS",clog_args)}};var _bindUi=function(){_$briefing_container=$("#sli_briefing");_$briefing_view=$("[data-js=sli_briefing_view]");_$briefing_preview_container=$('[data-js="sli_briefing_preview_container"]');_$briefing_header=$('[data-js="sli_briefing_header"]');TS.highlights_briefing.$briefing_header=_$briefing_header;TS.highlights_briefing.$briefing_view=_$briefing_view;_$briefing_container.on("click",".sli_briefing__message ts-message, .sli_briefing_target",function(e){if(!$(e.target).is("ts-message, .message_content, .message_body, .message_content_header_left, .sli_briefing_target, .comment, .rxn_panel")&&!$(e.target).parents(".message_body").length||$(e.target).parents(".msg_inline_file_preview_toggler").length){return}var $message=$(this).is("ts-message")?$(this):$(this).parents("ts-message");var msg_ts=$message.data("ts")+"";var model_ob_id=$message.data("model-ob-id")+"";_jumpToMessageInChannel(model_ob_id,msg_ts)});_$briefing_container.on("click",".sli_briefing__channel_link .channel_link",function(e){var channel_id=$(e.target).data("channel-id");if(channel_id[0]==="G"){TS.groups.displayGroup({id:channel_id})}});_$briefing_container.on("click",'[data-js="sli_briefing_preview"]',function(){_interface_state.expanded=true;$('[data-js="sli_briefing_preview_container"]').addClass("hidden");_$briefing_view.removeClass("hidden");_$briefing_header.removeClass("hidden");TS.client.ui.checkInlineImgsAndIframes("unread");var payload={request_id:_last_request_id};var cached_channel_id=_.keys(_cached_messages)[0];var cached_msg_ts=_.keys(_.get(_cached_messages,[cached_channel_id]))[0];var cached_request_id=_.get(_cached_messages,[cached_channel_id,cached_msg_ts,"cached_request_id"]);if(cached_request_id){payload.cached_request_id=cached_request_id}TS.clog.track("BRIEFING_REVEAL",payload);_interface_state.briefing_opens_count+=1;TS.storage.storeBriefingOpensCount(_interface_state.briefing_opens_count);TS.highlights_briefing.updated_sig.dispatch()});_$briefing_header.off("click").on("click",'[data-js="sli_briefing_header_dismiss_all"]',function(){_interface_state.expanded=false;_$briefing_preview_container.removeClass("hidden");_$briefing_view.addClass("hidden");_$briefing_header.addClass("hidden");_renderCollapsedView(null,0,true);var briefings=_getActiveBriefings();var briefing_message_stubs=_.map(briefings,function(message){return{channel_id:message.channel.id,ts:message.ts}});TS.api.call("highlights.dismissAll",{request_id:_last_request_id,messages:JSON.stringify(briefing_message_stubs)}).catch(function(e){TS.error(e)})});_$briefing_container.on("click",'[data-js="sli_briefing_feedback_item"] a',function(e){e.preventDefault();var cache_id=($(e.target).closest(".sli_briefing__feedback_leavebehind").data("feedback-for-cache-id")||"").split("-");var item_index=Number($(e.target).closest("li").data("index"));var model_ob_id=cache_id[0];var ts=cache_id[1];var message=_.get(_cached_messages,[model_ob_id,ts]);var feedback_args=_.get(message,["feedback_options","negative",item_index,"args"]);if(message&&feedback_args){_.assign(feedback_args,{request_id:message.request_id});if(message.cached_request_id){feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",feedback_args);var $briefing=$(e.target).closest(".sli_briefing__message");_feedbackAndDismiss($briefing,"dismiss",ts,model_ob_id)}});_$briefing_container.on("click","[data-feedback]",function(e){e.preventDefault();var type=$(e.target).data("feedback");var $briefing=$(e.target).closest(".sli_briefing__message");var cache_id=($briefing.data("cache-id")||"").split("-");var model_ob_id=cache_id[0];var ts=cache_id[1];TS.highlights_briefing.sendFeedback(e,type,ts,model_ob_id)})};var _unbindUi=function(){_$briefing_container.off("click");_$briefing_header.off("click")};var _jumpToMessageInChannel=function(model_ob_id,msg_ts){var request_id=_.get(_cached_messages,[model_ob_id,msg_ts,"request_id"]);var cached_request_id=_.get(_cached_messages,[model_ob_id,msg_ts,"cached_request_id"]);_interface_state.scroll_top=TS.client.ui.unread.$scroller.scrollTop();_interface_state.last_jump={ts:msg_ts,model_ob_id:model_ob_id};_interface_state.show_briefing_back_button=true;TS.recaps_signal.markMessagesAsHighlights(_.toArray(_cached_messages[model_ob_id]),model_ob_id);TS.client.ui.tryToJump(model_ob_id,msg_ts);var payload={channel_id:model_ob_id,channel_type:model_ob_id[0]||"",message_timestamp:msg_ts,request_id:request_id};if(cached_request_id){payload.cached_request_id=cached_request_id}TS.clog.track("BRIEFING_JUMP_TO_CHANNEL",payload)};var _dismissMessage=function($briefing,model_ob_id,callback){$briefing.addClass(_getFeedbackClass("dismiss"));setTimeout(function(){$briefing.css({transition:"margin-bottom 0.3s","margin-bottom":0});$briefing.animate({height:0},300,function(){var $parent=$briefing.parents('.sli_briefing__channel[data-channel-id="'+model_ob_id+'"]');$briefing.remove();if(_haveAllMessagesBeenDismissedInChannel(model_ob_id)){$parent.css({transition:"opacity 0.2s",opacity:.5})}if(callback)callback()})},300)};var _haveAllMessagesBeenDismissedInChannel=function(model_ob_id){return _.every(_cached_messages[model_ob_id],function(message,ts){return _cached_feedback[model_ob_id][ts]==="dismiss"})};var _showEmptyState=function(){_$briefing_container.replaceWith(TS.templates.sli_briefing());_$briefing_header.addClass("hidden");_bindUi();_renderCollapsedView(null,0,true)};var _feedbackAndDismiss=function($briefing,action,ts,model_ob_id){_setFeedback(action,ts,model_ob_id);_clogFeedback(action,ts,model_ob_id);_dismissMessage($briefing,model_ob_id,function(){if(!_getActiveBriefingCount()){_showEmptyState()}})};var _removeMessagesWithChannel=function(data){if(!TS.highlights_briefing.isEnabled())return;if(!_cached_messages||_.isEmpty(_cached_messages)||!_cached_messages[data.model_ob.id])return;_.each(_cached_messages[data.model_ob.id],function(message,ts){_cached_messages[data.model_ob.id][ts]._removed=true});_$briefing_view.find('.sli_briefing__channel[data-channel-id="'+data.model_ob.id+'"]').addClass("hidden");TS.highlights_briefing.updated_sig.dispatch()};var _unremoveMessagesWithChannel=function(data){if(!TS.highlights_briefing.isEnabled())return;if(!_cached_messages||_.isEmpty(_cached_messages)||!_cached_messages[data.model_ob.id])return;_.each(_cached_messages[data.model_ob.id],function(message,ts){_cached_messages[data.model_ob.id][ts]._removed=false});_$briefing_view.find('.sli_briefing__channel[data-channel-id="'+data.model_ob.id+'"]').removeClass("hidden");TS.highlights_briefing.updated_sig.dispatch()}})();
